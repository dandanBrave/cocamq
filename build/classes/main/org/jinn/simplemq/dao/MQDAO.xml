<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="MQDAO">
	<typeAlias alias="Message" type="org.jinn.simplemq.entity.MessageJson" />
	<insert id="addMessage" parameterClass="java.util.HashMap">
	   INSERT INTO $tableName$ (msgUID,msgTopic,msgType,objectId,userId,memo,ip,addTime)
	   VALUES(#msgUID#,#msgTopic#,#msgType#,#objectId#,#userId#,#memo#,#ip#, NOW())
	</insert>
	<select id="getMessageById" parameterClass="java.util.HashMap" resultClass="Message">
	   SELECT * FROM $tableName$ WHERE id = #msgId#
	</select>
	<select id="getMessageByUID" parameterClass="java.util.HashMap" resultClass="int">
	   SELECT count(*) FROM $tableName$ WHERE msgUID = #uuid#
	</select>
	<select id="getMessageBefore" parameterClass="java.util.HashMap" resultClass="Message">
	   SELECT * FROM $tableName$ WHERE addTime >= #dateStr# 
	    <isNotEmpty property="topics">
	      AND msgTopic in ($topics$)
	    </isNotEmpty>
	   ORDER BY id ASC
	</select>
	<update id="createTable" parameterClass="string">
	   CREATE TABLE $tableName$ (
			  `id` int(9) NOT NULL auto_increment,
			  `msgUID` varchar(32) default NULL,
			  `msgTopic` varchar(30) default NULL,
			  `msgType` varchar(20) NOT NULL default '0',
			  `objectId` int(9) NOT NULL default '0',
			  `userId` int(9) NOT NULL default '0',
			  `ip` int(10) NOT NULL default '0',
			  `memo` text,
			  `addTime` datetime NOT NULL default '0000-00-00 00:00:00',
			  PRIMARY KEY  (`id`),
			  UNIQUE KEY `UID_INDEX` (`msgUID`),
			  KEY `user_index` (`userId`),
			  KEY `date_index` (`addTime`),
			  KEY `topic_index` (`msgTopic`)
			) ENGINE=InnoDB DEFAULT CHARSET=gbk
	</update>
	<select id="checkTable" parameterClass="string" resultClass="long">
	   SELECT count(*) FROM $tableName$
	</select>
</sqlMap>